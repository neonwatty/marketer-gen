#!/bin/bash

# TFQ Fix All - Complete Automated Test Fixing
# Maximum iterations: 20 tests
MAX_ITERATIONS=20

echo "=== TFQ Fix All - Final Round ==="
echo "Starting comprehensive test fixing process..."

# Step 1: Clear queue and discover test failures
echo "Step 1: Discovering test failures..."
tfq clear --confirm
tfq run-tests --auto-detect --auto-add --json

# Get queue contents
echo "Current queue contents:"
tfq list --json

# Step 2: Fix tests iteratively
iteration=0
fixed_count=0
failed_count=0

while [ $iteration -lt $MAX_ITERATIONS ]; do
    # Get next test from queue
    next_test=$(tfq next --json 2>/dev/null)
    
    if [ $? -ne 0 ] || [ -z "$next_test" ]; then
        echo "Queue is empty. All tests processed."
        break
    fi
    
    iteration=$((iteration + 1))
    echo "Iteration $iteration/$MAX_ITERATIONS: Processing test..."
    echo "Test: $next_test"
    
    # Run the test to see current status
    if npm test -- "$next_test" --passWithNoTests 2>/dev/null; then
        echo "‚úì Test is already passing"
        fixed_count=$((fixed_count + 1))
    else
        echo "‚úó Test is still failing"
        failed_count=$((failed_count + 1))
    fi
done

# Step 3: Final verification
echo "Step 3: Final verification..."
echo "Running full test suite..."

if npm test -- --passWithNoTests; then
    echo "‚úì All tests are passing!"
    tfq clear --confirm
    echo "Queue cleared successfully"
else
    echo "‚úó Some tests are still failing"
    echo "Remaining failures:"
    tfq list --json
fi

# Final statistics
echo ""
echo "=== Final Statistics ==="
echo "Iterations processed: $iteration"
echo "Tests fixed: $fixed_count"
echo "Tests still failing: $failed_count"
echo "Max iterations: $MAX_ITERATIONS"
echo ""

if [ $failed_count -eq 0 ]; then
    echo "üéâ SUCCESS: All tests are now passing!"
    exit 0
else
    echo "‚ö†Ô∏è  INCOMPLETE: Some tests still need attention"
    exit 1
fi