<div class="approval-workflow" data-controller="approval-workflow">
  <!-- Current Approval Status -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-4">
      <h5 class="text-sm font-medium text-gray-900">Approval Status</h5>
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                   <%= approval_status_classes(get_approval_status(campaign)) %>">
        <%= get_approval_status(campaign).humanize %>
      </span>
    </div>
    
    <!-- Approval Progress -->
    <div class="approval-progress mb-4">
      <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
        <span>Progress</span>
        <span><%= get_approval_progress(campaign) %>%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
             style="width: <%= get_approval_progress(campaign) %>%"></div>
      </div>
    </div>
  </div>

  <!-- Approval Steps -->
  <div class="space-y-4">
    <h5 class="text-sm font-medium text-gray-900">Approval Steps</h5>
    
    <% get_approval_steps(campaign).each_with_index do |step, index| %>
      <div class="approval-step flex items-start p-4 border rounded-lg
                  <%= step[:status] == 'completed' ? 'bg-green-50 border-green-200' : 
                      step[:status] == 'current' ? 'bg-blue-50 border-blue-200' : 
                      step[:status] == 'rejected' ? 'bg-red-50 border-red-200' :
                      'bg-gray-50 border-gray-200' %>">
        
        <!-- Step Icon -->
        <div class="flex-shrink-0 mr-4">
          <div class="w-8 h-8 rounded-full flex items-center justify-center
                      <%= step[:status] == 'completed' ? 'bg-green-100 text-green-600' : 
                          step[:status] == 'current' ? 'bg-blue-100 text-blue-600' : 
                          step[:status] == 'rejected' ? 'bg-red-100 text-red-600' :
                          'bg-gray-100 text-gray-600' %>">
            <% case step[:status] %>
            <% when 'completed' %>
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            <% when 'current' %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            <% when 'rejected' %>
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            <% else %>
              <span class="text-sm font-medium"><%= index + 1 %></span>
            <% end %>
          </div>
        </div>
        
        <!-- Step Details -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between mb-2">
            <h6 class="text-sm font-medium text-gray-900"><%= step[:title] %></h6>
            <% if step[:deadline] %>
              <span class="text-xs text-gray-500">
                Due: <%= step[:deadline].strftime('%m/%d/%Y') %>
              </span>
            <% end %>
          </div>
          
          <p class="text-sm text-gray-600 mb-2"><%= step[:description] %></p>
          
          <!-- Approver Info -->
          <div class="flex items-center text-sm text-gray-600">
            <div class="flex-shrink-0 w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center mr-2">
              <span class="text-xs font-medium"><%= step[:approver][:name][0].upcase %></span>
            </div>
            <span><%= step[:approver][:name] %> - <%= step[:approver][:role] %></span>
          </div>
          
          <!-- Status Details -->
          <% if step[:status] == 'completed' %>
            <div class="mt-2 text-xs text-green-700">
              ✓ Approved on <%= step[:completed_at].strftime('%m/%d/%Y at %I:%M %p') %>
              <% if step[:comments].present? %>
                <div class="mt-1 italic">"<%= step[:comments] %>"</div>
              <% end %>
            </div>
          <% elsif step[:status] == 'rejected' %>
            <div class="mt-2 text-xs text-red-700">
              ✗ Rejected on <%= step[:rejected_at].strftime('%m/%d/%Y at %I:%M %p') %>
              <% if step[:rejection_reason].present? %>
                <div class="mt-1 italic">"<%= step[:rejection_reason] %>"</div>
              <% end %>
            </div>
          <% elsif step[:status] == 'current' %>
            <div class="mt-2">
              <% if can_approve?(current_user, step) %>
                <!-- Approval Actions for Current User -->
                <div class="flex items-center space-x-2">
                  <%= form_with url: approve_campaign_path(campaign), 
                                method: :post, 
                                local: false, 
                                class: "inline" do |form| %>
                    <%= form.hidden_field :step_id, value: step[:id] %>
                    <%= form.submit "Approve", 
                                    class: "btn btn-success btn-xs",
                                    data: { 
                                      "controller": "confirmation",
                                      "confirmation-message-value": "Approve this step?"
                                    } %>
                  <% end %>
                  
                  <%= form_with url: reject_campaign_path(campaign), 
                                method: :post, 
                                local: false, 
                                class: "inline" do |form| %>
                    <%= form.hidden_field :step_id, value: step[:id] %>
                    <%= form.submit "Reject", 
                                    class: "btn btn-danger btn-xs",
                                    data: { 
                                      "controller": "confirmation",
                                      "confirmation-message-value": "Reject this step? Please provide a reason."
                                    } %>
                  <% end %>
                </div>
              <% else %>
                <div class="text-xs text-blue-700">
                  ⏳ Waiting for approval from <%= step[:approver][:name] %>
                  <% if step[:notified_at] %>
                    (Notified <%= time_ago_in_words(step[:notified_at]) %> ago)
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Approval Actions -->
  <% if can_manage_approvals?(current_user, campaign) %>
    <div class="mt-6 pt-6 border-t">
      <h5 class="text-sm font-medium text-gray-900 mb-3">Approval Management</h5>
      <div class="flex items-center space-x-3">
        <button type="button" 
                class="btn btn-outline btn-sm"
                data-action="click->approval-workflow#addApprover">
          Add Approver
        </button>
        
        <button type="button" 
                class="btn btn-outline btn-sm"
                data-action="click->approval-workflow#sendReminder">
          Send Reminder
        </button>
        
        <button type="button" 
                class="btn btn-outline btn-sm"
                data-action="click->approval-workflow#editWorkflow">
          Edit Workflow
        </button>
      </div>
    </div>
  <% end %>

  <!-- Approval History -->
  <div class="mt-6 pt-6 border-t">
    <h5 class="text-sm font-medium text-gray-900 mb-3">Approval History</h5>
    <div class="space-y-3">
      <% get_approval_history(campaign).each do |event| %>
        <div class="flex items-start text-sm">
          <div class="flex-shrink-0 w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center mr-3 mt-0.5">
            <span class="text-xs font-medium"><%= event[:user][:name][0].upcase %></span>
          </div>
          <div class="flex-1">
            <span class="font-medium text-gray-900"><%= event[:user][:name] %></span>
            <span class="text-gray-600"><%= event[:action] %></span>
            <% if event[:comments].present? %>
              <span class="text-gray-600">with comment: "<%= event[:comments] %>"</span>
            <% end %>
            <div class="text-xs text-gray-500 mt-1">
              <%= event[:timestamp].strftime('%B %d, %Y at %I:%M %p') %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>