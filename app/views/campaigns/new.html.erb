<% content_for :title, "Create New Campaign" %>
<% content_for :description, "Create a comprehensive marketing campaign with our guided form wizard" %>

<div class="campaign-form-container max-w-4xl mx-auto" 
     data-controller="campaign-form form-validation auto-save"
     data-campaign-form-current-step-value="<%= @step %>"
     data-auto-save-url-value="<%= campaign_draft_save_path if @campaign.persisted? %>"
     role="main" 
     aria-label="Campaign creation form">

  <!-- Progress Header -->
  <div class="bg-white rounded-lg border mb-8 overflow-hidden">
    <!-- Progress Bar -->
    <div class="bg-gray-50 px-6 py-4 border-b">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold text-gray-900">Create Campaign</h1>
        <button type="button" 
                class="text-gray-400 hover:text-gray-600"
                data-action="click->campaign-form#showHelp"
                aria-label="Show form help">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </button>
      </div>
      
      <!-- Step Progress -->
      <div class="flex items-center justify-between" role="progressbar" aria-valuenow="<%= @step %>" aria-valuemin="1" aria-valuemax="5">
        <% [
          { step: '1', title: 'Campaign Details', description: 'Basic information and goals' },
          { step: '2', title: 'Target Audience', description: 'Persona and demographics' },
          { step: '3', title: 'Strategy & Content', description: 'Messaging and channels' },
          { step: '4', title: 'Timeline & Budget', description: 'Schedule and resources' },
          { step: '5', title: 'Review & Launch', description: 'Final review and activation' }
        ].each_with_index do |step_info, index| %>
          <div class="flex-1 <%= 'mr-4' unless index == 4 %>">
            <div class="flex items-center">
              <!-- Step Circle -->
              <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-colors
                           <%= @step.to_i > step_info[:step].to_i ? 'bg-green-600 border-green-600 text-white' : 
                               @step.to_i == step_info[:step].to_i ? 'bg-blue-600 border-blue-600 text-white' : 
                               'bg-white border-gray-300 text-gray-500' %>"
                     aria-label="Step <%= step_info[:step] %><%= @step.to_i > step_info[:step].to_i ? ' completed' : @step.to_i == step_info[:step].to_i ? ' current' : ' upcoming' %>">
                  <% if @step.to_i > step_info[:step].to_i %>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                  <% else %>
                    <span class="text-sm font-medium"><%= step_info[:step] %></span>
                  <% end %>
                </div>
              </div>
              
              <!-- Step Info -->
              <div class="ml-3 min-w-0 flex-1 <%= 'hidden sm:block' if index > 2 %>">
                <div class="text-sm font-medium <%= @step.to_i >= step_info[:step].to_i ? 'text-gray-900' : 'text-gray-500' %>">
                  <%= step_info[:title] %>
                </div>
                <div class="text-xs text-gray-500 hidden md:block">
                  <%= step_info[:description] %>
                </div>
              </div>
              
              <!-- Connector Line -->
              <% unless index == 4 %>
                <div class="hidden sm:block w-8 h-0.5 mx-2 <%= @step.to_i > step_info[:step].to_i ? 'bg-green-600' : 'bg-gray-300' %>"></div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Auto-save Status -->
    <div class="px-6 py-2 bg-gray-25 border-b hidden" data-auto-save-target="status">
      <div class="flex items-center text-sm text-gray-600">
        <svg class="w-4 h-4 mr-2 animate-spin hidden" data-auto-save-target="spinner" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <svg class="w-4 h-4 mr-2 text-green-600 hidden" data-auto-save-target="checkmark" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
        </svg>
        <span data-auto-save-target="message">Draft saved automatically</span>
      </div>
    </div>
  </div>

  <!-- Form Content -->
  <%= form_with model: @campaign, 
                local: true, 
                class: "campaign-form",
                "data-campaign-form-target": "form",
                "data-form-validation-target": "form",
                "data-auto-save-target": "form",
                "aria-label": "Campaign creation form" do |form| %>
    
    <!-- Hidden Step Field -->
    <%= form.hidden_field :current_step, value: @step, "data-campaign-form-target": "stepInput" %>
    
    <!-- Step 1: Campaign Details -->
    <div class="form-step <%= 'hidden' unless @step == '1' %>" 
         data-campaign-form-target="step" 
         data-step="1"
         role="tabpanel"
         aria-labelledby="step-1-title">
      
      <div class="bg-white rounded-lg border p-8">
        <div class="mb-8">
          <h2 id="step-1-title" class="text-xl font-bold text-gray-900 mb-2">Campaign Details</h2>
          <p class="text-gray-600">Let's start with the basic information about your campaign.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Left Column -->
          <div class="space-y-6">
            <!-- Campaign Name -->
            <div>
              <%= form.label :name, "Campaign Name", 
                             class: "block text-sm font-medium text-gray-700 mb-2",
                             for: "campaign_name" %>
              <%= form.text_field :name, 
                                  class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",
                                  placeholder: "e.g., Summer Product Launch 2024",
                                  required: true,
                                  "data-form-validation-target": "field",
                                  "data-validation-rules": "required|max:255",
                                  "aria-describedby": "name-help",
                                  "data-auto-save-target": "input" %>
              <p id="name-help" class="text-sm text-gray-500 mt-1">
                Choose a clear, descriptive name that identifies your campaign's purpose.
              </p>
              <div class="text-sm text-red-600 mt-1 hidden" data-form-validation-target="error"></div>
            </div>

            <!-- Campaign Type -->
            <div>
              <%= form.label :campaign_type, "Campaign Type", 
                             class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.select :campaign_type, 
                              options_for_select([
                                ['Select campaign type...', ''],
                                ['Product Launch', 'product_launch'],
                                ['Brand Awareness', 'brand_awareness'],
                                ['Lead Generation', 'lead_generation'],
                                ['Customer Retention', 'customer_retention'],
                                ['Seasonal Promotion', 'seasonal_promotion'],
                                ['Content Marketing', 'content_marketing'],
                                ['Email Nurture', 'email_nurture'],
                                ['Social Media Campaign', 'social_media'],
                                ['Event Promotion', 'event_promotion'],
                                ['Customer Onboarding', 'customer_onboarding'],
                                ['Re-engagement', 're_engagement'],
                                ['Cross-sell/Upsell', 'cross_sell'],
                                ['Referral Program', 'referral'],
                                ['B2B Lead Generation', 'b2b_lead_generation']
                              ], @campaign.campaign_type),
                              {},
                              { class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",
                                required: true,
                                "data-form-validation-target": "field",
                                "data-validation-rules": "required",
                                "data-action": "change->campaign-form#handleTypeChange",
                                "data-auto-save-target": "input" } %>
              <div class="text-sm text-red-600 mt-1 hidden" data-form-validation-target="error"></div>
            </div>

            <!-- Primary Goal -->
            <div>
              <%= form.label :primary_goal, "Primary Goal", 
                             class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.select :primary_goal, 
                              options_for_select([
                                ['Select primary goal...', ''],
                                ['Increase Brand Awareness', 'brand_awareness'],
                                ['Generate Leads', 'lead_generation'],
                                ['Drive Sales', 'drive_sales'],
                                ['Improve Customer Retention', 'customer_retention'],
                                ['Launch New Product', 'product_launch'],
                                ['Build Community', 'community_building'],
                                ['Educate Market', 'market_education'],
                                ['Support Sales Team', 'sales_support']
                              ], @campaign.primary_goal),
                              {},
                              { class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",
                                required: true,
                                "data-form-validation-target": "field",
                                "data-validation-rules": "required",
                                "data-auto-save-target": "input" } %>
              <div class="text-sm text-red-600 mt-1 hidden" data-form-validation-target="error"></div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="space-y-6">
            <!-- Description -->
            <div>
              <%= form.label :description, "Campaign Description", 
                             class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :description, 
                                 rows: 4,
                                 class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none",
                                 placeholder: "Describe your campaign's purpose, target audience, and expected outcomes...",
                                 "data-form-validation-target": "field",
                                 "data-validation-rules": "max:1000",
                                 "aria-describedby": "description-help",
                                 "data-auto-save-target": "input" %>
              <p id="description-help" class="text-sm text-gray-500 mt-1">
                Provide a clear overview of what this campaign aims to achieve. This helps team members understand the campaign's context.
              </p>
              <div class="text-sm text-red-600 mt-1 hidden" data-form-validation-target="error"></div>
            </div>

            <!-- Success Metrics -->
            <div>
              <%= form.label :success_metrics, "Success Metrics", 
                             class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :success_metrics, 
                                 rows: 3,
                                 class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none",
                                 placeholder: "e.g., 500 qualified leads, 25% increase in brand awareness, $50K in revenue...",
                                 "data-auto-save-target": "input" %>
              <p class="text-sm text-gray-500 mt-1">
                Define measurable outcomes that will determine campaign success.
              </p>
            </div>
          </div>
        </div>

        <!-- Conditional Content Based on Campaign Type -->
        <div class="mt-8 conditional-content" data-campaign-form-target="conditionalContent">
          <!-- Content will be loaded dynamically based on campaign type -->
        </div>
      </div>
    </div>

    <!-- Step 2: Target Audience -->
    <div class="form-step <%= 'hidden' unless @step == '2' %>" 
         data-campaign-form-target="step" 
         data-step="2"
         role="tabpanel"
         aria-labelledby="step-2-title">
      
      <div class="bg-white rounded-lg border p-8">
        <div class="mb-8">
          <h2 id="step-2-title" class="text-xl font-bold text-gray-900 mb-2">Target Audience</h2>
          <p class="text-gray-600">Define who you're trying to reach with this campaign.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Left Column -->
          <div class="space-y-6">
            <!-- Persona Selection -->
            <div>
              <%= form.label :persona_id, "Target Persona", 
                             class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.collection_select :persona_id, 
                                         @personas, 
                                         :id, 
                                         :name, 
                                         { prompt: 'Select a target persona...' },
                                         { class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",
                                           required: true,
                                           "data-form-validation-target": "field",
                                           "data-validation-rules": "required",
                                           "data-action": "change->campaign-form#handlePersonaChange",
                                           "data-auto-save-target": "input" } %>
              <div class="text-sm text-red-600 mt-1 hidden" data-form-validation-target="error"></div>
              
              <!-- Create New Persona Link -->
              <div class="mt-2">
                <%= link_to "Create new persona", "#", 
                            class: "text-sm text-blue-600 hover:text-blue-700 underline",
                            "data-action": "click->campaign-form#showPersonaModal" %>
              </div>
            </div>

            <!-- Target Audience Details -->
            <div>
              <%= form.label :target_audience, "Additional Audience Details", 
                             class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :target_audience, 
                                 rows: 4,
                                 class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none",
                                 placeholder: "Describe any specific audience segments, demographics, or behavioral characteristics...",
                                 "data-auto-save-target": "input" %>
              <p class="text-sm text-gray-500 mt-1">
                Provide additional context about your target audience beyond the selected persona.
              </p>
            </div>
          </div>

          <!-- Right Column -->
          <div class="space-y-6">
            <!-- Persona Preview -->
            <div class="persona-preview bg-gray-50 rounded-lg p-6" data-campaign-form-target="personaPreview">
              <div class="text-center text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <p class="text-sm">Select a persona to see details</p>
              </div>
            </div>

            <!-- Audience Size Estimation -->
            <div class="audience-size bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="text-sm font-medium text-blue-900 mb-2">Estimated Audience Size</h4>
              <div class="text-2xl font-bold text-blue-900" data-campaign-form-target="audienceSize">
                --
              </div>
              <p class="text-sm text-blue-700 mt-1">
                Based on your selected persona and targeting criteria
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Steps -->
    <%= render 'form_steps_3_to_5' %>

    <!-- Navigation Buttons -->
    <div class="flex items-center justify-between mt-8 bg-white rounded-lg border p-6">
      <!-- Previous Button -->
      <% if @step.to_i > 1 %>
        <%= button_tag "Previous", 
                       type: "button",
                       class: "btn btn-outline px-6 py-3 inline-flex items-center",
                       "data-action": "click->campaign-form#previousStep",
                       "aria-label": "Go to previous step" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Previous
        <% end %>
      <% else %>
        <div></div>
      <% end %>

      <!-- Save Draft & Continue -->
      <div class="flex items-center space-x-3">
        <!-- Save Draft -->
        <%= button_tag "Save Draft", 
                       type: "button",
                       class: "btn btn-outline px-4 py-3",
                       "data-action": "click->campaign-form#saveDraft",
                       "aria-label": "Save current progress as draft" %>

        <!-- Next/Complete Button -->
        <% if @step.to_i < 5 %>
          <%= button_tag "Continue", 
                         type: "button",
                         class: "btn btn-primary px-6 py-3 inline-flex items-center",
                         "data-action": "click->campaign-form#nextStep",
                         "data-campaign-form-target": "nextButton",
                         "aria-label": "Continue to next step" do %>
            Continue
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          <% end %>
        <% else %>
          <%= form.submit "Create Campaign", 
                          class: "btn btn-primary px-6 py-3",
                          "data-campaign-form-target": "submitButton" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Help Modal -->
  <div class="fixed inset-0 z-50 hidden" data-campaign-form-target="helpModal" role="dialog" aria-labelledby="help-modal-title" aria-hidden="true">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" data-action="click->campaign-form#hideHelp"></div>
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
        <div class="flex items-center justify-between mb-4">
          <h3 id="help-modal-title" class="text-lg font-bold text-gray-900">Campaign Creation Help</h3>
          <button type="button" 
                  class="text-gray-400 hover:text-gray-600"
                  data-action="click->campaign-form#hideHelp"
                  aria-label="Close help modal">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="prose prose-sm max-w-none">
          <h4>Step-by-Step Guide</h4>
          <ol>
            <li><strong>Campaign Details:</strong> Define your campaign's basic information, type, and primary objectives.</li>
            <li><strong>Target Audience:</strong> Select your target persona and define audience characteristics.</li>
            <li><strong>Strategy & Content:</strong> Plan your messaging approach and choose marketing channels.</li>
            <li><strong>Timeline & Budget:</strong> Set your campaign schedule and allocate resources.</li>
            <li><strong>Review & Launch:</strong> Review all settings and activate your campaign.</li>
          </ol>
          
          <h4>Tips for Success</h4>
          <ul>
            <li>Be specific with your campaign goals and success metrics</li>
            <li>Choose personas that closely match your ideal customers</li>
            <li>Consider your budget when selecting channels and tactics</li>
            <li>Plan for sufficient time to create and approve content</li>
            <li>Test your campaign with a small audience first</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>