<%# React-based Journey Builder - Interactive Visual Interface %>
<% content_for :title, "Journey Builder" %>
<% content_for :head do %>
  <%= javascript_importmap_tags %>
  <script type="module" nonce="<%= content_security_policy_nonce %>">
    import "journey_builder_react";
  </script>
<% end %>

<!-- React Journey Builder Container -->
<div 
  id="react-journey-builder" 
  data-template-id="<%= @template&.id %>"
  data-journey-data="<%= (@template ? {
    id: @template.id,
    name: @template.name,
    description: @template.description,
    steps: @template.steps_data || [],
    connections: @template.connections_data || [],
    status: @template.published? ? 'published' : 'draft'
  }.to_json : '{}').html_safe %>"
>
  <!-- Loading state while React loads -->
  <div class="loading-state">
    <div class="loading-spinner">
      <svg class="animate-spin h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
    <p>Loading Journey Builder...</p>
  </div>
</div>

<style>
  /* Loading state styles */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: #f9fafb;
  }

  .loading-spinner {
    margin-bottom: 16px;
  }

  .loading-state p {
    color: #6b7280;
    font-size: 16px;
  }

  /* Ensure React Flow styles are loaded */
  @import url('https://cdn.jsdelivr.net/npm/reactflow@11.11.4/dist/style.css');

  /* Custom React Flow overrides */
  .react-flow__node.selected {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
  }

  .react-flow__edge.selected {
    stroke: #3b82f6;
    stroke-width: 3;
  }

  .react-flow__controls {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .react-flow__controls button {
    background: white;
    border: none;
    color: #374151;
    font-size: 16px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .react-flow__controls button:hover {
    background: #f3f4f6;
    color: #1f2937;
  }

  .react-flow__minimap {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  /* Animation for spinner */
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  /* Hide loading state once React loads */
  #react-journey-builder[data-react-loaded="true"] .loading-state {
    display: none;
  }
</style>

<!-- Fallback for JavaScript disabled -->
<noscript>
  <div class="javascript-required">
    <h2>JavaScript Required</h2>
    <p>The Journey Builder requires JavaScript to function. Please enable JavaScript in your browser and refresh the page.</p>
    <a href="<%= journey_templates_path %>" class="fallback-link">Return to Templates</a>
  </div>
  
  <style>
    .javascript-required {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f9fafb;
      text-align: center;
      padding: 2rem;
    }

    .javascript-required h2 {
      color: #dc2626;
      margin-bottom: 1rem;
    }

    .javascript-required p {
      color: #6b7280;
      margin-bottom: 2rem;
      max-width: 400px;
    }

    .fallback-link {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
    }

    .fallback-link:hover {
      text-decoration: underline;
    }
  </style>
</noscript>