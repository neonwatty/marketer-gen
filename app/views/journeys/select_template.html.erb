<div class="container mx-auto px-6 py-8" data-controller="template-selector">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Choose a Journey Template</h1>
      <p class="text-gray-600 mt-2">Select a template that matches your campaign goals and customize it to fit your needs</p>
    </div>

    <!-- Guided Questions Section -->
    <% if @guided_questions.any? %>
      <div class="mb-8 bg-blue-50 border border-blue-200 rounded-lg p-6" 
           data-template-selector-target="guidedQuestions"
           role="region"
           aria-label="Guided template selection questions">
        <% question = @guided_questions.first %>
        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="bg-blue-100 rounded-full p-2">
              <span class="text-blue-600 font-semibold text-sm">Step <%= question[:step] %></span>
            </div>
          </div>
          <div class="flex-1">
            <h3 id="question-<%= question[:step] %>" class="text-lg font-semibold text-gray-900 mb-2"><%= question[:question] %></h3>
            <p class="text-gray-600 mb-4"><%= question[:description] %></p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"
                 role="group"
                 aria-labelledby="question-<%= question[:step] %>">
              <% question[:options].each do |option| %>
                <%= form_with url: select_template_journeys_path, method: :get, local: false, 
                    data: { 
                      turbo_frame: "template-content",
                      action: "submit->template-selector#handleQuestionResponse"
                    }, 
                    class: "contents" do |form| %>
                  
                  <!-- Preserve existing filters -->
                  <% @filters.each do |key, value| %>
                    <%= form.hidden_field key, value: value %>
                  <% end %>
                  
                  <%= form.hidden_field question[:type], value: option[:value] %>
                  
                  <button type="submit" 
                          class="text-left p-4 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 hover:scale-102 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                          role="button"
                          aria-label="Select <%= option[:label] %> - <%= option[:description] %>">
                    <div class="flex items-start space-x-3">
                      <% if option[:icon] %>
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                          <i class="lucide-<%= option[:icon] %> w-4 h-4 text-blue-600"></i>
                        </div>
                      <% end %>
                      <div>
                        <div class="font-medium text-gray-900"><%= option[:label] %></div>
                        <% if option[:description] %>
                          <div class="text-sm text-gray-500 mt-1"><%= option[:description] %></div>
                        <% end %>
                      </div>
                    </div>
                  </button>
                <% end %>
              <% end %>
            </div>
            
            <% if question[:allow_skip] %>
              <div class="mt-4">
                <%= link_to "Skip this step", select_template_journeys_path(@filters), 
                    class: "text-sm text-gray-500 hover:text-gray-700",
                    data: { turbo_frame: "template-content" } %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Main Content Area -->
    <%= turbo_frame_tag "template-content" do %>
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Sidebar Filters -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg border border-gray-200 p-6 sticky top-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Refine Results</h3>
            
            <%= form_with url: select_template_journeys_path, method: :get, local: false,
                data: { 
                  turbo_frame: "template-content",
                  controller: "auto-submit",
                  action: "change->auto-submit#submit"
                },
                class: "space-y-4" do |form| %>
              
              <!-- Search -->
              <div>
                <%= form.label :search, "Search templates", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.text_field :search, value: @filters[:search], 
                    placeholder: "Search by name or description",
                    class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" %>
              </div>
              
              <!-- Campaign Type -->
              <div>
                <%= form.label :campaign_type, "Campaign Type", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.select :campaign_type, 
                    options_for_select([["All Types", ""]] + @filter_options[:campaign_types].map {|t| [t.humanize, t]}, @filters[:campaign_type]),
                    {},
                    { class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" } %>
              </div>
              
              <!-- Complexity Level -->
              <div>
                <%= form.label :complexity_level, "Experience Level", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.select :complexity_level,
                    options_for_select([["All Levels", ""]] + @filter_options[:complexity_levels].map {|l| [l.humanize, l]}, @filters[:complexity_level]),
                    {},
                    { class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" } %>
              </div>
              
              <!-- Industry -->
              <div>
                <%= form.label :industry, "Industry", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.select :industry,
                    options_for_select([["All Industries", ""]] + @filter_options[:industries].map {|i| [i.humanize, i]}, @filters[:industry]),
                    {},
                    { class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" } %>
              </div>
              
              <!-- Category -->
              <div>
                <%= form.label :category, "Focus Area", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.select :category,
                    options_for_select([["All Categories", ""]] + @filter_options[:categories].map {|c| [c.humanize, c]}, @filters[:category]),
                    {},
                    { class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" } %>
              </div>
              
              <!-- Clear Filters -->
              <div class="pt-4 border-t border-gray-200">
                <%= link_to "Clear all filters", select_template_journeys_path, 
                    class: "text-sm text-gray-500 hover:text-gray-700",
                    data: { turbo_frame: "template-content" } %>
              </div>
            <% end %>
            
            <!-- Filter Summary -->
            <% if @filters.any? %>
              <div class="mt-6 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Active Filters:</h4>
                <div class="space-y-1">
                  <% @filters.each do |key, value| %>
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-gray-600"><%= key.to_s.humanize %>:</span>
                      <span class="text-gray-900 font-medium"><%= value.humanize %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Analytics -->
            <div class="mt-6 pt-4 border-t border-gray-200">
              <h4 class="text-sm font-medium text-gray-900 mb-2">Results:</h4>
              <div class="text-sm text-gray-600">
                <div><%= pluralize(@template_analytics[:total_templates], 'template') %> found</div>
                <% if @template_analytics[:recommended_count] > 0 %>
                  <div class="text-green-600"><%= @template_analytics[:recommended_count] %> beginner-friendly</div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Templates Grid -->
        <div class="lg:col-span-3">
          <% if @templates.any? %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" data-template-selector-target="templatesGrid">
              <% @templates.each do |template| %>
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow"
                     data-template-id="<%= template.id %>"
                     data-template-selector-target="templateCard">
                  
                  <!-- Template Header -->
                  <div class="p-6 border-b border-gray-200">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2"><%= template.name %></h3>
                        <p class="text-gray-600 text-sm mb-3"><%= template.description %></p>
                        
                        <!-- Template Metadata -->
                        <div class="flex flex-wrap gap-2">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <%= template.campaign_type.humanize %>
                          </span>
                          <% if template.complexity_level %>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                       <%= template.complexity_level == 'beginner' ? 'bg-green-100 text-green-800' : 
                                           template.complexity_level == 'expert' ? 'bg-purple-100 text-purple-800' : 
                                           'bg-yellow-100 text-yellow-800' %>">
                              <%= template.complexity_level.humanize %>
                            </span>
                          <% end %>
                          <% if template.industry %>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <%= template.industry.humanize %>
                            </span>
                          <% end %>
                        </div>
                      </div>
                      
                      <!-- Actions -->
                      <div class="ml-4 flex flex-col space-y-2">
                        <button type="button"
                                data-action="click->template-selector#showPreview"
                                data-template-id="<%= template.id %>"
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                          Preview
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Template Stats -->
                  <div class="px-6 py-4 bg-gray-50">
                    <div class="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div class="text-lg font-semibold text-gray-900">
                          <%= template.template_data["stages"]&.length || 0 %>
                        </div>
                        <div class="text-xs text-gray-500">Stages</div>
                      </div>
                      <div>
                        <div class="text-lg font-semibold text-gray-900">
                          <%= template.template_data["steps"]&.length || 0 %>
                        </div>
                        <div class="text-xs text-gray-500">Steps</div>
                      </div>
                      <div>
                        <div class="text-lg font-semibold text-gray-900">
                          <%= template.get_timeline || "Flexible" %>
                        </div>
                        <div class="text-xs text-gray-500">Timeline</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Use Template Button -->
                  <div class="p-6 bg-white">
                    <%= form_with url: create_from_template_journeys_path, 
                        data: { 
                          controller: "template-form",
                          action: "submit->template-form#showCustomization"
                        },
                        class: "space-y-3" do |form| %>
                      
                      <%= form.hidden_field :template_id, value: template.id %>
                      
                      <div>
                        <%= form.text_field :journey_name, 
                            value: "#{template.name} Journey",
                            placeholder: "Journey name",
                            class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" %>
                      </div>
                      
                      <%= form.submit "Use This Template", 
                          class: "w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <!-- No Templates Found -->
            <div class="text-center py-12">
              <div class="max-w-sm mx-auto">
                <div class="mb-4">
                  <i class="lucide-search w-16 h-16 text-gray-300 mx-auto"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No templates found</h3>
                <p class="text-gray-600 mb-4">Try adjusting your filters or search terms to find relevant templates.</p>
                <%= link_to "Clear all filters", select_template_journeys_path,
                    class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-600 bg-blue-100 hover:bg-blue-200",
                    data: { turbo_frame: "template-content" } %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Template Preview Modal -->
  <div data-template-selector-target="previewModal" 
       class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">Template Preview</h3>
          <button type="button" 
                  data-action="click->template-selector#closePreview"
                  class="text-gray-400 hover:text-gray-600">
            <i class="lucide-x w-6 h-6"></i>
          </button>
        </div>
        <div data-template-selector-target="previewContent">
          <!-- Preview content will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>