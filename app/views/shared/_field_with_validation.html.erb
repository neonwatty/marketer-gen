<%#
  Reusable form field component with validation
  
  Usage:
  <%= render 'shared/field_with_validation', 
      form: form,
      field_name: :email_address,
      field_type: :email_field,
      label: "Email Address",
      required: true,
      server_validation: true,
      table_name: "users",
      placeholder: "Enter your email",
      help_text: "We'll never share your email",
      css_classes: "additional-classes" %>

<%
  # Set defaults
  field_type ||= :text_field
  label ||= field_name.to_s.humanize
  required ||= false
  server_validation ||= false
  table_name ||= nil
  placeholder ||= nil
  help_text ||= nil
  css_classes ||= ""
  record_id ||= form.object&.id
  user_scoped ||= false
  
  # Build field attributes
  field_attrs = {
    required: required,
    placeholder: placeholder,
    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 #{css_classes}",
    data: {
      "form-validation-target": "field"
    }
  }
  
  # Add server validation attributes if enabled
  if server_validation && table_name
    field_attrs[:data].merge!({
      "server-validation": "true",
      "table-name": table_name,
      "field-name": field_name,
      "user-scoped": user_scoped
    })
    
    field_attrs[:data]["record-id"] = record_id if record_id.present?
  end
  
  # Remove nil values
  field_attrs.compact!
  field_attrs[:data].compact!
%>

<div class="form-field-wrapper mb-4">
  <!-- Label -->
  <%= form.label field_name, class: "block text-sm font-medium text-gray-700 mb-1" do %>
    <%= label %>
    <% if required %>
      <span class="text-red-500">*</span>
    <% end %>
  <% end %>
  
  <!-- Field Container with Icon -->
  <div class="relative">
    <!-- Input Field -->
    <%= form.send(field_type, field_name, field_attrs) %>
    
    <!-- Validation Icons Container -->
    <div class="validation-icons absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
      <!-- Loading Icon -->
      <div class="validation-icon loading hidden">
        <svg class="w-5 h-5 text-gray-400 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      
      <!-- Success Icon -->
      <div class="validation-icon success hidden">
        <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
      </div>
      
      <!-- Error Icon -->
      <div class="validation-icon error hidden">
        <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>
  </div>
  
  <!-- Validation Feedback -->
  <div class="validation-feedback mt-1 min-h-[20px]"></div>
  
  <!-- Help Text -->
  <% if help_text %>
    <div class="mt-1 text-sm text-gray-500">
      <%= help_text %>
    </div>
  <% end %>
</div>