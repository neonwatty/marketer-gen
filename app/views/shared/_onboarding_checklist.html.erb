<%#
  Onboarding Checklist Component
  
  Usage:
  <%= render 'shared/onboarding_checklist', 
      user: current_user,
      compact: false,
      auto_hide: true,
      position: 'sticky' %>
%>

<%
  # Set defaults
  user ||= Current.user
  compact ||= false
  auto_hide ||= true
  position ||= 'fixed'
  
  # Don't render if user is nil
  return unless user

  # Check if user has dismissed the checklist
  dismissed_key = "onboarding-checklist-dismissed"
  
  # Determine if we should show the checklist
  service = SmartDefaultsService.new(user)
  progress = service.user_onboarding_progress
  completion_percentage = progress[:completion_percentage]
  
  # Auto-hide if completion is 100% and auto_hide is enabled
  should_hide = auto_hide && completion_percentage >= 100
  
  # CSS classes for positioning
  position_classes = case position
  when 'sticky'
    'sticky top-4 z-30'
  when 'fixed'
    'fixed bottom-4 right-4 z-50'
  else
    'relative'
  end
  
  wrapper_classes = [
    'onboarding-checklist-wrapper',
    position_classes,
    ('hidden' if should_hide),
    ('compact' if compact)
  ].compact.join(' ')
%>

<div class="<%= wrapper_classes %>" 
     data-controller="onboarding-checklist"
     data-onboarding-checklist-endpoint-value="/api/v1/suggestions/onboarding_progress"
     data-onboarding-checklist-auto-refresh-value="false">
  
  <div class="bg-white rounded-lg shadow-lg border border-gray-200 max-w-md">
    <!-- Header -->
    <div class="px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-semibold text-gray-900">Setup Progress</h3>
            <p class="text-xs text-gray-600" data-onboarding-checklist-target="progressText">
              <%= completion_percentage %>% complete
            </p>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <% unless compact %>
            <button type="button" 
                    class="text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition-colors"
                    data-action="click->onboarding-checklist#collapseChecklist"
                    title="Collapse checklist">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          <% end %>
          
          <button type="button" 
                  class="text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition-colors"
                  data-action="click->onboarding-checklist#dismissChecklist"
                  title="Dismiss checklist">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Progress Bar -->
      <div class="mt-3">
        <div class="bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all duration-500 ease-out"
               data-onboarding-checklist-target="progress"
               style="width: <%= completion_percentage %>%"
               role="progressbar"
               aria-valuenow="<%= completion_percentage %>"
               aria-valuemin="0"
               aria-valuemax="100">
          </div>
        </div>
      </div>
    </div>

    <!-- Checklist Content -->
    <div class="<%= 'hidden' if compact %>" data-onboarding-checklist-target="checklist">
      <div class="px-4 py-3">
        <div class="space-y-3">
          <!-- Profile Setup -->
          <div class="flex items-start space-x-3 <%= 'completed' if progress[:completed_steps].include?(:profile_setup) %>"
               data-onboarding-checklist-target="step"
               data-step="profile_setup">
            <div class="flex-shrink-0 mt-1">
              <div data-onboarding-step="icon">
                <% if progress[:completed_steps].include?(:profile_setup) %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% else %>
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% end %>
              </div>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-gray-900 <%= 'line-through text-gray-500' if progress[:completed_steps].include?(:profile_setup) %>"
                  data-onboarding-step="text">
                Complete Profile
              </h4>
              <p class="text-xs text-gray-600">Add your company and role information</p>
            </div>
          </div>

          <!-- Brand Identity -->
          <div class="flex items-start space-x-3 <%= 'completed' if progress[:completed_steps].include?(:brand_identity) %>"
               data-onboarding-checklist-target="step"
               data-step="brand_identity">
            <div class="flex-shrink-0 mt-1">
              <div data-onboarding-step="icon">
                <% if progress[:completed_steps].include?(:brand_identity) %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% else %>
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% end %>
              </div>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-gray-900 <%= 'line-through text-gray-500' if progress[:completed_steps].include?(:brand_identity) %>"
                  data-onboarding-step="text">
                Create Brand Identity
              </h4>
              <p class="text-xs text-gray-600">Set up brand voice and guidelines</p>
            </div>
          </div>

          <!-- First Campaign -->
          <div class="flex items-start space-x-3 <%= 'completed' if progress[:completed_steps].include?(:first_campaign) %>"
               data-onboarding-checklist-target="step"
               data-step="first_campaign">
            <div class="flex-shrink-0 mt-1">
              <div data-onboarding-step="icon">
                <% if progress[:completed_steps].include?(:first_campaign) %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% else %>
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% end %>
              </div>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-gray-900 <%= 'line-through text-gray-500' if progress[:completed_steps].include?(:first_campaign) %>"
                  data-onboarding-step="text">
                Create First Campaign
              </h4>
              <p class="text-xs text-gray-600">Build your first marketing campaign plan</p>
            </div>
          </div>

          <!-- First Journey -->
          <div class="flex items-start space-x-3 <%= 'completed' if progress[:completed_steps].include?(:first_journey) %>"
               data-onboarding-checklist-target="step"
               data-step="first_journey">
            <div class="flex-shrink-0 mt-1">
              <div data-onboarding-step="icon">
                <% if progress[:completed_steps].include?(:first_journey) %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% else %>
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% end %>
              </div>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-gray-900 <%= 'line-through text-gray-500' if progress[:completed_steps].include?(:first_journey) %>"
                  data-onboarding-step="text">
                Create Customer Journey
              </h4>
              <p class="text-xs text-gray-600">Map customer touchpoints and engagement</p>
            </div>
          </div>

          <!-- Content Generation -->
          <div class="flex items-start space-x-3 <%= 'completed' if progress[:completed_steps].include?(:content_generation) %>"
               data-onboarding-checklist-target="step"
               data-step="content_generation">
            <div class="flex-shrink-0 mt-1">
              <div data-onboarding-step="icon">
                <% if progress[:completed_steps].include?(:content_generation) %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% else %>
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% end %>
              </div>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-gray-900 <%= 'line-through text-gray-500' if progress[:completed_steps].include?(:content_generation) %>"
                  data-onboarding-step="text">
                Generate Content
              </h4>
              <p class="text-xs text-gray-600">Create marketing materials and copy</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Next Action Section -->
    <div class="px-4 py-3 border-t border-gray-100 bg-gray-50"
         data-onboarding-checklist-target="nextAction">
      <% if progress[:next_suggested_action] && progress[:completion_percentage] < 100 %>
        <% 
          action_config = case progress[:next_suggested_action]
          when :complete_profile
            { title: "Complete Your Profile", description: "Add your company and role information", url: "/profile/edit", text: "Complete Profile" }
          when :create_brand_identity
            { title: "Create Brand Identity", description: "Set up your brand voice and guidelines", url: "/brand_identities/new", text: "Create Brand Identity" }
          when :create_first_campaign
            { title: "Create Your First Campaign", description: "Build your first marketing campaign plan", url: "/campaign_plans/new", text: "Create Campaign" }
          when :create_first_journey
            { title: "Create Customer Journey", description: "Map customer touchpoints and engagement", url: "/journeys/new", text: "Create Journey" }
          when :generate_content
            { title: "Generate Content", description: "Create marketing materials and copy", url: "/generated_contents", text: "Generate Content" }
          else
            { title: "Continue Setup", description: "Complete your account setup", url: "/help", text: "Continue" }
          end
        %>
        
        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-sm font-medium text-blue-800">
                Next: <%= action_config[:title] %>
              </h3>
              <p class="mt-1 text-xs text-blue-700">
                <%= action_config[:description] %>
              </p>
              <div class="mt-2">
                <a href="<%= action_config[:url] %>" 
                   class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                  <%= action_config[:text] %>
                  <svg class="ml-1 -mr-0.5 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </div>
      <% else %>
        <div class="bg-green-50 border border-green-200 rounded-md p-3">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-green-800">
                🎉 Setup Complete!
              </h3>
              <p class="mt-1 text-xs text-green-700">
                You're ready to create amazing marketing campaigns.
              </p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Compact Mode Trigger (when collapsed) -->
<% if compact %>
  <div class="fixed bottom-4 right-4 z-50">
    <button type="button"
            class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
            data-action="click->onboarding-checklist#expandChecklist"
            title="Show setup progress">
      <div class="relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <% if progress[:completion_percentage] < 100 %>
          <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
            <%= 6 - progress[:completed_steps].length %>
          </span>
        <% end %>
      </div>
    </button>
  </div>
<% end %>