<%
  # Progress Indicator Partial
  # Usage: <%= render "shared/progress_indicator", steps: ["Step 1", "Step 2", "Step 3"], current: 2 %>
  
  steps = local_assigns[:steps] || []
  current = local_assigns[:current] || 1
  completed = local_assigns[:completed] || []
  size = local_assigns[:size] || "md"
  classes = local_assigns[:classes] || ""
  id = local_assigns[:id]
  hidden = local_assigns[:hidden] || false
  
  # Size mappings
  size_classes = {
    "sm" => { 
      circle: "w-6 h-6 text-xs",
      text: "text-xs",
      spacing: "space-x-2"
    },
    "md" => { 
      circle: "w-8 h-8 text-sm",
      text: "text-sm", 
      spacing: "space-x-4"
    },
    "lg" => { 
      circle: "w-10 h-10 text-base",
      text: "text-base",
      spacing: "space-x-6"
    }
  }
  
  size_config = size_classes[size] || size_classes["md"]
  
  container_classes = [
    "flex items-center justify-center",
    size_config[:spacing],
    classes
  ].join(" ")
  
  container_classes += " hidden" if hidden
%>

<div class="<%= container_classes %>" 
     <%= "id=\"#{id}\"".html_safe if id %>
     role="progressbar"
     aria-valuemin="1"
     aria-valuemax="<%= steps.length %>"
     aria-valuenow="<%= current %>"
     aria-label="Progress: Step <%= current %> of <%= steps.length %>">
  
  <% steps.each_with_index do |step, index| %>
    <% 
      step_number = index + 1
      is_current = step_number == current
      is_completed = completed.include?(step_number) || step_number < current
      is_upcoming = step_number > current
    %>
    
    <!-- Step circle and connector -->
    <div class="flex items-center">
      <!-- Step circle -->
      <div class="relative flex items-center justify-center <%= size_config[:circle] %> rounded-full font-semibold
                  <%= if is_completed
                        'bg-green-600 text-white'
                      elsif is_current  
                        'bg-blue-600 text-white ring-4 ring-blue-200'
                      else
                        'bg-gray-200 text-gray-600'
                      end %>">
        
        <% if is_completed %>
          <!-- Checkmark icon -->
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        <% else %>
          <!-- Step number -->
          <%= step_number %>
        <% end %>
        
        <!-- Current step pulse animation -->
        <% if is_current %>
          <div class="absolute inset-0 rounded-full bg-blue-600 animate-ping opacity-25"></div>
        <% end %>
      </div>
      
      <!-- Step label (below circle) -->
      <div class="absolute top-full mt-2 left-1/2 transform -translate-x-1/2 whitespace-nowrap">
        <span class="<%= size_config[:text] %> font-medium
                     <%= if is_completed
                           'text-green-600'
                         elsif is_current
                           'text-blue-600'
                         else
                           'text-gray-500'
                         end %>">
          <%= step %>
        </span>
      </div>
      
      <!-- Connector line to next step -->
      <% unless index == steps.length - 1 %>
        <div class="flex-1 h-0.5 mx-4
                    <%= if step_number < current
                          'bg-green-600'
                        elsif step_number == current  
                          'bg-gray-300'
                        else
                          'bg-gray-200'
                        end %>
                    relative">
          
          <!-- Animated progress line for current step -->
          <% if step_number == current %>
            <div class="absolute inset-0 bg-blue-600 origin-left transform transition-transform duration-1000 ease-out"
                 style="transform: scaleX(0)">
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
  
  <!-- Screen reader progress announcement -->
  <div class="sr-only" aria-live="polite" aria-atomic="true">
    Step <%= current %> of <%= steps.length %>: <%= steps[current - 1] if steps[current - 1] %>
  </div>
</div>

<!-- Optional step details -->
<% if local_assigns[:show_details] %>
  <div class="mt-8 text-center">
    <h3 class="text-lg font-semibold text-gray-900 mb-2">
      <%= steps[current - 1] if steps[current - 1] %>
    </h3>
    <p class="text-sm text-gray-600">
      Step <%= current %> of <%= steps.length %>
    </p>
  </div>
<% end %>