<% content_for :title, "Admin - Audit Logs" %>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-8">Admin Audit Logs</h1>
  
  <!-- Admin Navigation -->
  <div class="bg-white shadow rounded-lg mb-8">
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8 px-6" aria-label="Admin Tabs">
        <a href="/admin" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
          Dashboard
        </a>
        <a href="/admin/users" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
          Users
        </a>
        <a href="/admin/activities" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
          Activities
        </a>
        <a href="/admin/audit_logs" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
          Audit Logs
        </a>
      </nav>
    </div>
  </div>

  <!-- Audit Logs Table -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Admin Audit Logs (<%= @audit_logs.count %>)</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin User</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changes</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @audit_logs.each do |log| %>
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= log.id %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= log.user&.email_address || "System" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    <%= case log.action
                        when /create/, /add/ then 'bg-green-100 text-green-800'
                        when /update/, /edit/ then 'bg-blue-100 text-blue-800'
                        when /delete/, /remove/ then 'bg-red-100 text-red-800'
                        when /suspend/ then 'bg-yellow-100 text-yellow-800'
                        else 'bg-gray-100 text-gray-800'
                        end %>">
                    <%= log.action.humanize %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div><%= log.auditable_type %> #<%= log.auditable_id %></div>
                  <% if log.auditable_type == "User" && log.auditable_id.present? %>
                    <% target_user = User.find_by(id: log.auditable_id) %>
                    <% if target_user %>
                      <div class="text-xs text-gray-400"><%= target_user.email_address %></div>
                    <% end %>
                  <% end %>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <% if log.change_details.present? %>
                    <% begin %>
                      <% changes = JSON.parse(log.change_details) %>
                      <% if changes.is_a?(Hash) && changes.any? %>
                        <div class="max-w-xs">
                          <% changes.each do |key, value| %>
                            <div class="text-xs">
                              <strong><%= key.humanize %>:</strong>
                              <% if value.is_a?(Array) && value.length == 2 %>
                                <span class="text-red-600"><%= value[0].to_s.truncate(20) %></span>
                                â†’
                                <span class="text-green-600"><%= value[1].to_s.truncate(20) %></span>
                              <% else %>
                                <%= value.to_s.truncate(30) %>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="text-xs text-gray-400">
                          <%= log.change_details.truncate(50) %>
                        </div>
                      <% end %>
                    <% rescue JSON::ParserError %>
                      <div class="text-xs text-gray-400">
                        <%= log.change_details.truncate(50) %>
                      </div>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">-</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= log.ip_address %>
                  <% if log.user_agent.present? %>
                    <div class="text-xs text-gray-400" title="<%= log.user_agent %>">
                      <%= log.user_agent.truncate(20) %>
                    </div>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= time_ago_in_words(log.created_at) %> ago
                  <div class="text-xs text-gray-400">
                    <%= log.created_at.strftime('%b %d, %Y %I:%M %p') %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if @audit_logs.empty? %>
        <div class="text-center py-8">
          <div class="text-gray-500">No audit logs found.</div>
          <div class="text-sm text-gray-400 mt-2">Admin actions will be logged here for security and compliance.</div>
        </div>
      <% end %>
    </div>
  </div>
</div>