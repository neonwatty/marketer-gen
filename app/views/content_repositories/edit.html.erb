<% content_for :title, "Edit #{@content_repository.title}" %>

<div class="content-editor-container" data-controller="content-editor" data-content-editor-auto-save-url-value="<%= api_v1_content_repositories_path %>">
  <!-- Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
    <div>
      <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li class="inline-flex items-center">
            <%= link_to content_repositories_path, class: "inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              Content Library
            <% end %>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <%= link_to @content_repository.title, @content_repository, class: "ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2 truncate" %>
            </div>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Edit</span>
            </div>
          </li>
        </ol>
      </nav>
      
      <h1 class="text-3xl font-bold text-gray-900">Edit Content</h1>
      <p class="mt-2 text-gray-600">Make changes and create a new version</p>
    </div>
    
    <div class="flex space-x-3 mt-4 lg:mt-0">
      <%= link_to "Cancel", @content_repository, 
          class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" %>
    </div>
  </div>

  <!-- Current Version Info -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex items-start">
      <div class="flex-shrink-0">
        <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-800">Editing Version <%= @current_version&.version_number || 'Latest' %></h3>
        <div class="mt-1 text-sm text-blue-700">
          <p>Any changes you make will create a new version of this content.</p>
          <% if @current_version %>
            <p class="mt-1">Current version created by <%= @current_version.author.display_name %> <%= time_ago_in_words(@current_version.created_at) %> ago</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <%= form_with model: @content_repository, 
      class: "content-editor-form",
      data: { 
        action: "submit->content-editor#handleSubmit",
        content_editor_target: "form"
      } do |form| %>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content Area (2/3) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Content Metadata -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Content Details</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Title -->
            <div class="md:col-span-2">
              <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :title, 
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                  placeholder: "Enter content title...",
                  data: { 
                    action: "input->content-editor#titleChanged",
                    content_editor_target: "titleField"
                  } %>
              <% if @content_repository.errors[:title].any? %>
                <p class="mt-1 text-sm text-red-600"><%= @content_repository.errors[:title].first %></p>
              <% end %>
            </div>

            <!-- Content Type -->
            <div>
              <%= form.label :content_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.select :content_type, 
                  options_for_select(@content_types.map { |type| [type.titleize, type] }, @content_repository.content_type),
                  { prompt: "Select content type..." },
                  { 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                    data: { 
                      action: "change->content-editor#contentTypeChanged",
                      content_editor_target: "contentTypeField"
                    }
                  } %>
              <% if @content_repository.errors[:content_type].any? %>
                <p class="mt-1 text-sm text-red-600"><%= @content_repository.errors[:content_type].first %></p>
              <% end %>
            </div>

            <!-- Format -->
            <div>
              <%= form.label :format, class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.select :format, 
                  options_for_select(@formats.map { |format| [format.titleize, format] }, @content_repository.format),
                  { prompt: "Select format..." },
                  { 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                    data: { 
                      action: "change->content-editor#formatChanged",
                      content_editor_target: "formatField"
                    }
                  } %>
              <% if @content_repository.errors[:format].any? %>
                <p class="mt-1 text-sm text-red-600"><%= @content_repository.errors[:format].first %></p>
              <% end %>
            </div>

            <!-- Description -->
            <div class="md:col-span-2">
              <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :description, 
                  rows: 3,
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                  placeholder: "Brief description of this content..." %>
              <% if @content_repository.errors[:description].any? %>
                <p class="mt-1 text-sm text-red-600"><%= @content_repository.errors[:description].first %></p>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Content Editor -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <!-- Editor Header -->
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-gray-900">Content Editor</h2>
              
              <!-- Editor Toolbar -->
              <div class="flex items-center space-x-2">
                <button type="button" 
                        data-action="click->content-editor#togglePreview"
                        data-content-editor-target="previewToggle"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  Preview
                </button>

                <button type="button" 
                        data-action="click->content-editor#generateWithAI"
                        class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-sm font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  AI Enhance
                </button>
              </div>
            </div>
          </div>

          <!-- Editor Content -->
          <div class="relative">
            <!-- Editor View -->
            <div data-content-editor-target="editorView" class="p-6">
              <%= form.label :body, "Content", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :body, 
                  value: @current_version&.body,
                  rows: 20,
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono text-sm",
                  placeholder: "Edit your content here...",
                  data: {
                    action: "input->content-editor#contentChanged",
                    content_editor_target: "contentField"
                  } %>
            </div>

            <!-- Preview View (initially hidden) -->
            <div data-content-editor-target="previewView" class="hidden p-6 bg-gray-50">
              <h3 class="text-sm font-medium text-gray-700 mb-4">Preview</h3>
              <div data-content-editor-target="previewContent" class="prose max-w-none bg-white p-6 rounded border">
                <p class="text-gray-500 italic">Content preview will appear here...</p>
              </div>
            </div>
          </div>

          <!-- Auto-save Status -->
          <div class="px-6 py-3 bg-gray-50 rounded-b-lg border-t border-gray-200">
            <div class="flex items-center justify-between text-sm">
              <div data-content-editor-target="autoSaveStatus" class="text-gray-500">
                <!-- Auto-save status will be updated here -->
              </div>
              <div class="text-gray-500">
                Word count: <span data-content-editor-target="wordCount" class="font-medium">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar (1/3) -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Version Information -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Version Info</h3>
          
          <% if @current_version %>
            <dl class="space-y-3 text-sm">
              <div>
                <dt class="font-medium text-gray-500">Current Version</dt>
                <dd class="text-gray-900">v<%= @current_version.version_number %></dd>
              </div>
              <div>
                <dt class="font-medium text-gray-500">Last Modified</dt>
                <dd class="text-gray-900"><%= @current_version.updated_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
              </div>
              <div>
                <dt class="font-medium text-gray-500">Author</dt>
                <dd class="text-gray-900"><%= @current_version.author.display_name %></dd>
              </div>
            </dl>
          <% end %>
        </div>

        <!-- Campaign Association -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Campaign</h3>
          
          <%= form.label :campaign_id, "Associate with Campaign", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :campaign_id, 
              options_from_collection_for_select(@campaigns, :id, :name, @content_repository.campaign_id),
              { prompt: "Select campaign (optional)" },
              { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" } %>
          <p class="mt-2 text-xs text-gray-500">Associate this content with a specific campaign for better organization</p>
        </div>

        <!-- Content Settings -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Settings</h3>
          
          <!-- Target Audience -->
          <div class="mb-4">
            <%= form.label :target_audience, class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :target_audience, 
                class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                placeholder: "e.g., Young professionals, B2B decision makers" %>
          </div>

          <!-- Keywords -->
          <div class="mb-4">
            <%= form.label :keywords, class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :keywords, 
                class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                placeholder: "marketing, automation, growth" %>
            <p class="mt-1 text-xs text-gray-500">Comma-separated keywords for searchability</p>
          </div>

          <!-- Meta Data -->
          <div class="mb-4">
            <%= form.label :meta_data, "Additional Metadata", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_area :meta_data, 
                rows: 3,
                class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                placeholder: "JSON metadata or additional notes..." %>
            <p class="mt-1 text-xs text-gray-500">Additional structured data in JSON format</p>
          </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Save Changes</h3>
          
          <!-- Commit Message -->
          <div class="mb-4">
            <%= label_tag :commit_message, "Version Message", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= text_field_tag :commit_message, "Updated content", 
                class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
                placeholder: "Describe your changes..." %>
          </div>

          <!-- Submit Buttons -->
          <div class="space-y-3">
            <%= form.submit "Save Changes", 
                class: "w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors",
                data: { 
                  action: "click->content-editor#saveDraft",
                  content_editor_target: "saveButton"
                } %>
            
            <button type="button" 
                    data-action="click->content-editor#saveForReview"
                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-yellow-300 text-sm font-medium rounded-md text-yellow-700 bg-yellow-50 hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors">
              Save & Submit for Review
            </button>
          </div>
        </div>

        <!-- AI Assistance -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-6">
          <h3 class="text-lg font-semibold text-blue-900 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            AI Assistance
          </h3>
          
          <p class="text-sm text-blue-700 mb-4">Enhance your content with AI-powered suggestions and improvements.</p>
          
          <div class="space-y-3">
            <button type="button" 
                    data-action="click->content-editor#improveContent"
                    class="w-full inline-flex justify-center items-center px-3 py-2 border border-blue-300 text-sm font-medium rounded text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
              Improve Writing
            </button>
            
            <button type="button" 
                    data-action="click->content-editor#generateVariations"
                    class="w-full inline-flex justify-center items-center px-3 py-2 border border-blue-300 text-sm font-medium rounded text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              Generate Variations
            </button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Loading Overlay -->
<div data-content-editor-target="loadingOverlay" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
    <div class="flex items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <div class="ml-4">
        <p class="text-lg font-medium text-gray-900">Processing...</p>
        <p class="text-sm text-gray-500" data-content-editor-target="loadingMessage">Saving changes...</p>
      </div>
    </div>
  </div>
</div>